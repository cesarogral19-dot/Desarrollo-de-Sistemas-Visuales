version: '3.8'

services:
  # ==================
  # MONGODB
  # ==================
  mongodb:
    image: mongo:6.0-alpine
    container_name: mern-mongodb
    restart: unless-stopped
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-password123}
      MONGO_INITDB_DATABASE: mern-stack
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - mern-network
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', 'db.adminCommand("ping")']
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================
  # BACKEND (API)
  # ==================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mern-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    environment:
      PORT: 5000
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://${MONGODB_USER:-admin}:${MONGODB_PASSWORD:-password123}@mongodb:27017/mern-stack?authSource=admin
      MONGODB_USER: ${MONGODB_USER:-admin}
      MONGODB_PASSWORD: ${MONGODB_PASSWORD:-password123}
      JWT_SECRET: ${JWT_SECRET:-your_super_secret_jwt_key_change_in_production_12345}
      JWT_EXPIRE: ${JWT_EXPIRE:-7d}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      API_URL: ${API_URL:-http://localhost:5000}
      CLIENT_URL: ${CLIENT_URL:-http://localhost:3000}
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-10}
      LOG_LEVEL: ${LOG_LEVEL:-debug}
    depends_on:
      mongodb:
        condition: service_healthy
    volumes:
      - ./backend/src:/app/src
    networks:
      - mern-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================
  # FRONTEND (REACT)
  # ==================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mern-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    environment:
      VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:5000/api}
      VITE_APP_NAME: ${VITE_APP_NAME:-MERN Application}
      VITE_APP_ENVIRONMENT: ${VITE_APP_ENVIRONMENT:-production}
    depends_on:
      - backend
    networks:
      - mern-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ==================
# VOLÃšMENES
# ==================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local

# ==================
# REDES
# ==================
networks:
  mern-network:
    driver: bridge
